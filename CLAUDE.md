# Project Guide for Claude Code Sessions

Always read PLANNING.md at the start of every new conversation, check TASKS.md before starting your work, mark completed tasks to TASKS.md immediately, and add newly discovered tasks to TASKS.md when found.

## 1. Project Overview

Based on the Project Requirements Document (PRD), this project aims to solve two primary problems for researchers using OpenMM with custom force fields, specifically those generated by the Adaptive Force Matching (AFM) method.

**The Problems:**

1.  **Manual Parameter Transfer:** The process of manually copying force field parameters from CRYOFF's `.off` file format to OpenMM's `.xml` format is extremely tedious, time-consuming, and prone to human error.
2.  **PDB File Formatting:** Standard PDB files often lack the specific bonding information required by OpenMM for simulations that use custom forces, necessitating a manual and often confusing editing process.

**The Solution:**

We will build a suite of Python-based command-line tools to automate these processes. The goal is to create a seamless workflow for researchers, enabling them to easily use AFM-generated force fields for simulations in OpenMM.

## 2. Target Audience

The primary users of these tools will be:

*   Computational chemists and physicists.
*   Researchers using the Adaptive Force Matching (AFM) method.
*   Anyone who wants to run simulations with custom force fields on OpenMM, especially for GPU-accelerated or Path Integral Molecular Dynamics (PIMD) simulations.

## 3. Core Tasks

This project can be broken down into two main development tasks.

### Task 1: Force Field Converter (`off_to_openmm.py`) âœ… COMPLETED

**IMPLEMENTATION COMPLETE** - The script successfully converts `.off` files to complete OpenMM `.xml` force field files with full functionality.

**Implemented Features:**

1.  **Direct `.off` file parsing:**
    âœ… Handles format variations: `[MOLTYP]`/`[MOL]`, `[ATOMS]`/`[ATOM]`, etc.
    âœ… Extracts molecule definitions: atoms, bonds, angles, dihedrals per molecule type
    âœ… Handles special atoms (4*, NETF, TORQ, M, MMM) properly
    âœ… Parses `#define` parameter statements for bonded interactions
    âœ… Extracts nonbonded interactions: COU, EXP, SRD sections

2.  **Complete OpenMM XML generation:**
    âœ… `<AtomTypes>` section with element extraction and mass assignment
    âœ… `<Residues>` section with unique atom names (C0, C1, H0, H1) and bond connectivity
    âœ… `<NonbondedForce>` section with charges (sigma=0.0, epsilon=0.0, scales=1.0)
    âœ… `<HarmonicBondForce>` section with length and force constants
    âœ… `<HarmonicAngleForce>` section with degree-to-radian conversion
    âœ… `<PeriodicTorsionForce>` section with phase conversion and periodicities
    âœ… `<CustomNonbondedForce>` sections for EXP (exponential repulsion)
    âœ… `<CustomNonbondedForce>` sections for SRD (short-range dispersion, multiple powers)
    âœ… Proper `<ForceField>` wrapper tags

3.  **Multi-molecule and charge support:**
    âœ… `-off` flag for input .off file
    âœ… `-output` flag for output .xml file
    âœ… `-molnames` flag for selective molecule inclusion (comma-separated)
    âœ… `-charges` flag for external charge file integration
    âœ… Unit conversions (kcal/mol to kJ/mol, Angstrom to nm)

4.  **PDB Compatibility Enhancement (NEW):**
    âœ… `-molname_translations` flag for custom 3-letter residue name mapping
    âœ… Default behavior uses first 3 letters of molnames if no translations provided  
    âœ… Generates standard PDB-compatible 3-character residue names

**Usage Examples:**
- Single molecule: `python off_to_openmm.py -off input.off -output output.xml -molnames CYCQM -charges charges.dat`
- Multiple molecules: `python off_to_openmm.py -off input.off -output output.xml -molnames "CYCQM,H2OQM" -charges charges.dat`
- With custom translations: `python off_to_openmm.py -off input.off -output output.xml -molnames "CYCQM,H2OQM" -molname_translations "CYC,SOL" -charges charges.dat`
- Default 3-letter names: `python off_to_openmm.py -off input.off -output output.xml -molnames "CYCLOHEXENE,WATER"` (produces CYC, WAT)

**Test Cases Verified:**
âœ… 1-butanol molecular system
âœ… hydrated_cyclohexene (cyclohexene + water) system
âœ… Multi-molecule .off files with different format variations
âœ… Custom residue name translations (CYCQMâ†’CYC, H2OQMâ†’SOL)
âœ… Default 3-letter truncation behavior
    

### Task 2: PDB File Preprocessor (`pdb_preprocessor.py`) ðŸš§ IN PROGRESS

**STATUS:** Initial implementation complete, residue name compatibility resolved via off_to_openmm.py improvements.

The second task creates a standalone tool that processes PDB files for OpenMM compatibility.

**Implemented Features:**

1.  **PDB File Processing:**
    âœ… Reads standard PDB format files
    âœ… Parses ATOM/HETATM records with proper column positioning
    âœ… Handles residue names, atom names, and coordinates

2.  **Force Field Integration:**
    âœ… Reads OpenMM XML force field files to extract bond definitions
    âœ… Maps XML residue definitions to PDB residue names
    âœ… Supports residue name mapping (CYCâ†”CYCQM, SOLâ†”H2OQM)

3.  **Atom Type Conversion:**
    âœ… Detects when PDB contains atom classes vs atom types
    âœ… Converts atom classes to atom types when needed
    âœ… Preserves original atom names when appropriate

4.  **CONECT Record Generation:**
    âœ… Generates CONECT records based on force field bond definitions
    âœ… Maps XML atom names to PDB atom indices
    âœ… Avoids duplicate bond records

**Usage:**
```bash
python scripts/pdb_preprocessor.py -pdb input.pdb -xml forcefield.xml -output output.pdb
```

**Current Status:** Core functionality implemented. Testing revealed residue name compatibility issues between PDB files (3-letter names like "CYC", "SOL") and XML files (5-letter names like "CYCQM", "H2OQM"). This was resolved by enhancing off_to_openmm.py with the molname_translations feature to generate PDB-compatible XML files.

## Session Summary (Latest Development Cycle)

### Major Achievements This Session:

1. **PDB Preprocessor Implementation**: Created complete `scripts/pdb_preprocessor.py` with:
   - PDB file parsing and ATOM record extraction
   - XML force field integration for bond definitions  
   - Atom class to atom type conversion capabilities
   - CONECT record generation framework

2. **Critical Compatibility Issue Discovery**: Found mismatch between:
   - PDB residue names: 3 characters (CYC, SOL, WAT)
   - XML residue names: 5+ characters (CYCQM, H2OQM, etc.)

3. **Innovative Solution - Molname Translation Feature**: Enhanced `off_to_openmm.py` with:
   - New `-molname_translations` flag for custom 3-letter residue mappings
   - Automatic 3-letter truncation when no translations provided
   - Full backward compatibility with existing workflows

4. **Comprehensive Testing**: Verified functionality with:
   - Custom translations: `CYCQM,H2OQM â†’ CYC,SOL`
   - Default behavior: `CYCLOHEXENE,WATER â†’ CYC,WAT`
   - Real molecular data: hydrated_cyclohexene system

### Technical Implementation Details:

- **Enhanced XML Generation**: Modified `generate_residues_xml()` to accept and apply residue name translations
- **Argument Processing**: Added validation ensuring translation count matches molname count
- **Fallback Logic**: Intelligent default behavior using first 3 characters when no custom translations provided
- **PDB Format Compliance**: Ensures generated XML files are compatible with standard PDB conventions

### Problem Solving Approach:

Instead of complex residue name mapping in the PDB preprocessor, we solved the root cause by making the XML generator produce PDB-compatible names. This elegant solution eliminates mapping complexity while maintaining full functionality.

### Next Steps:

The PDB preprocessor is now ready for final testing and integration with the newly compatible XML files. The molname translation feature makes the entire workflow PDB-standard compliant.

## 4. Development Guidelines

*   **Language:** All scripts should be written in **Python 3**.
*   **Libraries:**
    *   For the `.off` parser, standard Python file I/O should be sufficient.
    *   For the `.xml` generator, use Python's built-in `xml.etree.ElementTree` library to ensure well-formed XML.
    *   A from-scratch implementation is also acceptable. Let's start without external libraries first.
*   **Style:** Write clean, readable, and well-commented code. Follow PEP 8 style guidelines.
*   **User Experience:** The tools should be command-line based. Use Python's `argparse` module to handle command-line arguments (e.g., input file paths, output file paths). Provide clear feedback to the user.
*   **Testing:** We should aim to create a `tests` directory with unit tests for our parsing and generation logic.

## 5. Suggested Workflow

1.  **Start with the Force Field Converter (`off_to_openmm.py`).** This is the highest priority task.
2.  Begin by focusing on parsing a sample `.off` file.
3.  Once parsing is reliable, move on to generating the XML structure.
4.  After the converter is functional, we can then develop the PDB preprocessor.
5.  Finally, we will write comprehensive documentation in a `README.md` file.

Let's start by creating the initial file structure for the project.


