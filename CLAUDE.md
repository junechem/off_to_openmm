# Project Guide for Claude Code Sessions

Always read PLANNING.md at the start of every new conversation, check TASKS.md before starting your work, mark completed tasks to TASKS.md immediately, and add newly discovered tasks to TASKS.md when found.

## 1. Project Overview

Based on the Project Requirements Document (PRD), this project aims to solve two primary problems for researchers using OpenMM with custom force fields, specifically those generated by the Adaptive Force Matching (AFM) method.

**The Problems:**

1.  **Manual Parameter Transfer:** The process of manually copying force field parameters from CRYOFF's `.off` file format to OpenMM's `.xml` format is extremely tedious, time-consuming, and prone to human error.
2.  **PDB File Formatting:** Standard PDB files often lack the specific bonding information required by OpenMM for simulations that use custom forces, necessitating a manual and often confusing editing process.

**The Solution:**

We will build a suite of Python-based command-line tools to automate these processes. The goal is to create a seamless workflow for researchers, enabling them to easily use AFM-generated force fields for simulations in OpenMM.

## 2. Target Audience

The primary users of these tools will be:

*   Computational chemists and physicists.
*   Researchers using the Adaptive Force Matching (AFM) method.
*   Anyone who wants to run simulations with custom force fields on OpenMM, especially for GPU-accelerated or Path Integral Molecular Dynamics (PIMD) simulations.

## 3. Core Tasks

This project can be broken down into two main development tasks.

### Task 1: Force Field Converter (`off_to_openmm.py`) ✅ COMPLETED

**IMPLEMENTATION COMPLETE** - The script successfully converts `.off` files to complete OpenMM `.xml` force field files with full functionality.

**Implemented Features:**

1.  **Direct `.off` file parsing:**
    ✅ Handles format variations: `[MOLTYP]`/`[MOL]`, `[ATOMS]`/`[ATOM]`, etc.
    ✅ Extracts molecule definitions: atoms, bonds, angles, dihedrals per molecule type
    ✅ Handles special atoms (4*, NETF, TORQ, M, MMM) properly
    ✅ Parses `#define` parameter statements for bonded interactions
    ✅ Extracts nonbonded interactions: COU, EXP, SRD sections

2.  **Complete OpenMM XML generation:**
    ✅ `<AtomTypes>` section with element extraction and mass assignment
    ✅ `<Residues>` section with unique atom names (C0, C1, H0, H1) and bond connectivity
    ✅ `<NonbondedForce>` section with charges (sigma=0.0, epsilon=0.0, scales=1.0)
    ✅ `<HarmonicBondForce>` section with length and force constants
    ✅ `<HarmonicAngleForce>` section with degree-to-radian conversion
    ✅ `<PeriodicTorsionForce>` section with phase conversion and periodicities
    ✅ `<CustomNonbondedForce>` sections for EXP (exponential repulsion)
    ✅ `<CustomNonbondedForce>` sections for SRD (short-range dispersion, multiple powers)
    ✅ Proper `<ForceField>` wrapper tags

3.  **Multi-molecule and charge support:**
    ✅ `-off` flag for input .off file
    ✅ `-output` flag for output .xml file
    ✅ `-molnames` flag for selective molecule inclusion (comma-separated)
    ✅ `-charges` flag for external charge file integration
    ✅ Unit conversions (kcal/mol to kJ/mol, Angstrom to nm)

**Usage Examples:**
- Single molecule: `python off_to_openmm.py -off input.off -output output.xml -molnames CYCQM -charges charges.dat`
- Multiple molecules: `python off_to_openmm.py -off input.off -output output.xml -molnames "CYCQM,H2OQM" -charges charges.dat`

**Test Cases Verified:**
✅ 1-butanol molecular system
✅ hydrated_cyclohexene (cyclohexene + water) system
✅ Multi-molecule .off files with different format variations
    


### Task 2: PDB File Preprocessor (`pdb_preprocessor.py`)

The second task is to create a standalone tool that adds the necessary bonding information (CONECT records) to a PDB file.

**Key Steps:**

1.  **Read an input PDB file.**
2.  **Analyze the molecular structure:** Determine the connectivity (bonds) between the atoms listed in the file. This will require reading in the completed force field .xml file
3.  **Append CONECT records:** Add the standard `CONECT` records to the end of the PDB file, which explicitly define the bonds.
4.  **Write the updated PDB file.**

## 4. Development Guidelines

*   **Language:** All scripts should be written in **Python 3**.
*   **Libraries:**
    *   For the `.off` parser, standard Python file I/O should be sufficient.
    *   For the `.xml` generator, use Python's built-in `xml.etree.ElementTree` library to ensure well-formed XML.
    *   A from-scratch implementation is also acceptable. Let's start without external libraries first.
*   **Style:** Write clean, readable, and well-commented code. Follow PEP 8 style guidelines.
*   **User Experience:** The tools should be command-line based. Use Python's `argparse` module to handle command-line arguments (e.g., input file paths, output file paths). Provide clear feedback to the user.
*   **Testing:** We should aim to create a `tests` directory with unit tests for our parsing and generation logic.

## 5. Suggested Workflow

1.  **Start with the Force Field Converter (`off_to_openmm.py`).** This is the highest priority task.
2.  Begin by focusing on parsing a sample `.off` file.
3.  Once parsing is reliable, move on to generating the XML structure.
4.  After the converter is functional, we can then develop the PDB preprocessor.
5.  Finally, we will write comprehensive documentation in a `README.md` file.

Let's start by creating the initial file structure for the project.


