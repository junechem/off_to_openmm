# Project Guide for Claude Code Sessions

Always read PLANNING.md at the start of every new conversation, check TASKS.md before starting your work, mark completed tasks to TASKS.md immediately, and add newly discovered tasks to TASKS.md when found.

## 1. Project Overview

Based on the Project Requirements Document (PRD), this project aims to solve two primary problems for researchers using OpenMM with custom force fields, specifically those generated by the Adaptive Force Matching (AFM) method.

**The Problems:**

1.  **Manual Parameter Transfer:** The process of manually copying force field parameters from CRYOFF's `.off` file format to OpenMM's `.xml` format is extremely tedious, time-consuming, and prone to human error.
2.  **PDB File Formatting:** Standard PDB files often lack the specific bonding information required by OpenMM for simulations that use custom forces, necessitating a manual and often confusing editing process.

**The Solution:**

We will build a suite of Python-based command-line tools to automate these processes. The goal is to create a seamless workflow for researchers, enabling them to easily use AFM-generated force fields for simulations in OpenMM.

## 2. Target Audience

The primary users of these tools will be:

*   Computational chemists and physicists.
*   Researchers using the Adaptive Force Matching (AFM) method.
*   Anyone who wants to run simulations with custom force fields on OpenMM, especially for GPU-accelerated or Path Integral Molecular Dynamics (PIMD) simulations.

## 3. Core Tasks

This project can be broken down into two main development tasks.

### Task 1: Force Field Converter (`off_to_openmm.py`)

The first and most critical task is to create a script that converts force field parameters from a `.off` file into a valid OpenMM `.xml` file. This script must handle multiple different molecular systems and .off file formats.

**Key Steps:**

1.  **Parse the `.off` file directly:**
    *   Read the input `.off` file provided by the user (not intermediate .dat files)
    *   Handle different .off file format variations (e.g., `[MOLTYP]` vs `[MOL]`, `[ATOMS]` vs `[ATOM]`)
    *   Extract molecular definitions: atoms, bonds, angles, dihedrals from each molecule type
    *   Extract final parameter definitions from `#define` statements at file end
    *   Extract nonbonded interactions: COU (Coulombic), EXP (exponential), SRD (short-range dispersion)
2.  **Map to OpenMM XML format:**
    *   Generate `<AtomTypes>` section from unique atom types found
    *   Generate `<Residues>` section with molecule definitions and connectivity
    *   Generate force sections: `<HarmonicBondForce>`, `<HarmonicAngleForce>`, `<PeriodicTorsionForce>`
    *   Generate nonbonded forces: `<CustomNonbondedForce>` for EXP and SRD interactions
3.  **Generate the `.xml` file:**
    *   Write the structured data into a well-formed OpenMM `.xml` file
    *   Support selective molecule inclusion via `-molnames` flag

**Command Line Interface:**
- `-molnames`: Specify which molecule types to include (e.g., "UNK,CYCQM")
- `-charges`: Path to charges file with "AtomType Charge" format for charge assignment
- Support multiple test cases: 1-butanol, hydrated_cyclohexene, and other molecular systems
    


### Task 2: PDB File Preprocessor (`pdb_preprocessor.py`)

The second task is to create a standalone tool that adds the necessary bonding information (CONECT records) to a PDB file.

**Key Steps:**

1.  **Read an input PDB file.**
2.  **Analyze the molecular structure:** Determine the connectivity (bonds) between the atoms listed in the file. This will require reading in the completed force field .xml file
3.  **Append CONECT records:** Add the standard `CONECT` records to the end of the PDB file, which explicitly define the bonds.
4.  **Write the updated PDB file.**

## 4. Development Guidelines

*   **Language:** All scripts should be written in **Python 3**.
*   **Libraries:**
    *   For the `.off` parser, standard Python file I/O should be sufficient.
    *   For the `.xml` generator, use Python's built-in `xml.etree.ElementTree` library to ensure well-formed XML.
    *   A from-scratch implementation is also acceptable. Let's start without external libraries first.
*   **Style:** Write clean, readable, and well-commented code. Follow PEP 8 style guidelines.
*   **User Experience:** The tools should be command-line based. Use Python's `argparse` module to handle command-line arguments (e.g., input file paths, output file paths). Provide clear feedback to the user.
*   **Testing:** We should aim to create a `tests` directory with unit tests for our parsing and generation logic.

## 5. Suggested Workflow

1.  **Start with the Force Field Converter (`off_to_openmm.py`).** This is the highest priority task.
2.  Begin by focusing on parsing a sample `.off` file.
3.  Once parsing is reliable, move on to generating the XML structure.
4.  After the converter is functional, we can then develop the PDB preprocessor.
5.  Finally, we will write comprehensive documentation in a `README.md` file.

Let's start by creating the initial file structure for the project.


