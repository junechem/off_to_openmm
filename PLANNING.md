# Project Planning: OFF to OpenMM

## 1. Vision

Our vision is to empower computational chemistry researchers by providing a seamless and automated workflow for using custom force fields, specifically those generated by the Adaptive Force Matching (AFM) method, within the OpenMM simulation ecosystem. We aim to eliminate the tedious and error-prone manual steps currently required, thereby accelerating research and expanding the user base of the AFM method.

This project will deliver a robust and user-friendly suite of command-line tools that bridge the gap between force field generation (CRYOFF `.off` files) and simulation (OpenMM `.xml` and `.pdb` files).

## 2. Architecture

The application will be composed of two distinct, single-purpose command-line tools, ensuring a modular and maintainable design.

### Tool 1: Force Field Converter (`off_to_openmm.py`) âœ… COMPLETED

*   **Input:** `-off` file path, `-output` path, optional `-molnames` and `-charges` flags
*   **Implemented Architecture:**
    1.  **OffFileParser Class:** Complete direct .off file parsing
        âœ… Handles format variations: `[MOLTYP]`/`[MOL]`, `[ATOMS]`/`[ATOM]`, etc.
        âœ… Extracts molecule definitions per section with special atom handling (4*, NETF, TORQ, M, MMM)
        âœ… Parses bonded interactions: BONDS, ANGLES, DIHEDRAL sections
        âœ… Parses nonbonded interactions: COU, EXP, SRD sections
        âœ… Extracts `#define` parameter statements for force constants
    
    2.  **Multi-Molecule Support System:**
        âœ… Supports multiple molecule types in single .off file
        âœ… Selective inclusion via `-molnames` flag (comma-separated)
        âœ… Unique atom naming across all molecules (C0, C1, H0, H1)
        âœ… Handles diverse molecular systems (organics, solvated systems)
    
    3.  **Charge Integration System:**
        âœ… Reads external charge files via `-charges` flag
        âœ… Format: "AtomType Charge" (e.g., "HW 0.6645")
        âœ… Integrates charges into NonbondedForce section (NOT Residues)
    
    4.  **Complete OpenMM XML Generation:**
        âœ… AtomTypes section with element extraction and mass assignment
        âœ… Residues section with unique naming and bond connectivity (no charges)
        âœ… NonbondedForce section with charges (sigma=0.0, epsilon=0.0, scales=1.0)
        âœ… HarmonicBondForce with unit-converted parameters
        âœ… HarmonicAngleForce with degree-to-radian conversion
        âœ… PeriodicTorsionForce with phase conversion and periodicities
        âœ… CustomNonbondedForce for EXP interactions (exponential repulsion)
        âœ… CustomNonbondedForce for SRD interactions (multiple powers, dispersion)
        âœ… Proper ForceField XML wrapper structure
    
    5.  **PDB Compatibility Enhancement (NEW):**
        âœ… `-molname_translations` flag for custom 3-letter residue name mapping
        âœ… Default behavior uses first 3 letters of molnames if no translations provided
        âœ… Generates standard PDB-compatible 3-character residue names (CYC, SOL, WAT)
        âœ… Full backward compatibility with existing workflows

*   **Output:** Complete, valid OpenMM `.xml` force field file ready for simulations with PDB-standard residue names

### Tool 2: PDB Preprocessor (`pdb_preprocessor.py`) ðŸš§ IMPLEMENTED

*   **Input:** `-pdb` file path, `-xml` force field file, `-output` path
*   **Core Logic Implemented:**
    1.  **PDB Parser:** âœ… Reads ATOM/HETATM records with proper column parsing
    2.  **XML Force Field Integration:** âœ… Reads completed .xml files to extract bond definitions
    3.  **Atom Type Conversion:** âœ… Detects and converts atom classes to atom types when needed  
    4.  **Residue Name Mapping:** âœ… Maps between PDB and XML residue naming conventions
    5.  **CONECT Record Generator:** âœ… Framework complete for generating standard PDB CONECT records
    6.  **File Writer:** âœ… Outputs updated PDB with connectivity information
*   **Output:** A new `.pdb` file containing the original coordinates plus appended bonding information
*   **Status:** Implementation complete, integration testing needed with PDB-compatible XML files

## 3. Technology Stack

*   **Programming Language:** Python 3.9+
*   **Core Libraries (Standard Library):**
    *   `argparse`: For creating a user-friendly command-line interface (CLI).
    *   `xml.etree.ElementTree`: For robust and safe generation of the `.xml` force field file.
*   **External Libraries (to be installed via pip):**
    *   `pytest`: For implementing a comprehensive suite of unit and integration tests.
*   **Code Style and Linting:**
    *   `black`: For automated, consistent code formatting.
    *   `ruff`: For fast and effective linting to catch errors and enforce best practices.

## 4. Required Tools & Environment

*   **Version Control:** `git` for tracking changes and collaboration.
*   **Python Environment:** A virtual environment (e.g., using `venv`) to manage project dependencies.
*   **Terminal:** A standard command-line terminal for running scripts and managing the project.
