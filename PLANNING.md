# Project Planning: OFF to OpenMM

## 1. Vision

Our vision is to empower computational chemistry researchers by providing a seamless and automated workflow for using custom force fields, specifically those generated by the Adaptive Force Matching (AFM) method, within the OpenMM simulation ecosystem. We aim to eliminate the tedious and error-prone manual steps currently required, thereby accelerating research and expanding the user base of the AFM method.

This project will deliver a robust and user-friendly suite of command-line tools that bridge the gap between force field generation (CRYOFF `.off` files) and simulation (OpenMM `.xml` and `.pdb` files).

## 2. Architecture

The application will be composed of two distinct, single-purpose command-line tools, ensuring a modular and maintainable design.

### Tool 1: Force Field Converter (`off_to_openmm.py`)

*   **Input:** A `.off` file path and optional flags (-molnames, -charges)
*   **Core Logic:**
    1.  **Direct .off Parser:** Parse .off files directly (NOT intermediate .dat files)
        - Handle format variations: `[MOLTYP]`/`[MOL]`, `[ATOMS]`/`[ATOM]`, etc.
        - Extract molecule definitions per MOLTYP/MOL section
        - Parse bonded interactions: BONDS, ANGLES, DIHEDRAL sections  
        - Parse nonbonded interactions: COU, EXP, SRD sections
        - Extract final `#define` parameter statements from file end
    2.  **Multi-Molecule Support:** 
        - Support multiple molecule types in single .off file (UNK, CYCQM, etc.)
        - Allow selective inclusion via `-molnames` flag
        - Handle different molecular systems (1-butanol, hydrated_cyclohexene, etc.)
    3.  **Charge Integration:**
        - Read separate charge files via `-charges` flag
        - Format: "AtomType Charge" (e.g., "C1 0.24499")
        - Integrate charges into residue definitions
    4.  **OpenMM XML Generation:**
        - AtomTypes section from unique atom types across all molecules
        - Residues section with molecule definitions and connectivity
        - Force sections: HarmonicBondForce, HarmonicAngleForce, PeriodicTorsionForce  
        - CustomNonbondedForce sections for EXP and SRD interactions
*   **Output:** Complete OpenMM `.xml` force field file supporting multiple molecular systems

### Tool 2: PDB Preprocessor (`pdb_preprocessor.py`)

*   **Input:** A `.pdb` file path provided as a command-line argument.
*   **Core Logic:**
    1.  **PDB Parser:** Reads the `ATOM` and `HETATM` records from the input PDB file.
    2.  **Connectivity Calculator:** This is the core of the tool. It will read the completed .xml force field file to understand connectivity in each molecule.
    3.  **CONECT Record Generator:** Based on the calculated bonds, this module will generate the `CONECT` records in the standard PDB format.
    4.  **File Writer:** Appends the generated `CONECT` records to the original PDB content and writes the result to a new output file.
*   **Output:** A new `.pdb` file containing the original atomic coordinates plus the appended bonding information.

## 3. Technology Stack

*   **Programming Language:** Python 3.9+
*   **Core Libraries (Standard Library):**
    *   `argparse`: For creating a user-friendly command-line interface (CLI).
    *   `xml.etree.ElementTree`: For robust and safe generation of the `.xml` force field file.
*   **External Libraries (to be installed via pip):**
    *   `pytest`: For implementing a comprehensive suite of unit and integration tests.
*   **Code Style and Linting:**
    *   `black`: For automated, consistent code formatting.
    *   `ruff`: For fast and effective linting to catch errors and enforce best practices.

## 4. Required Tools & Environment

*   **Version Control:** `git` for tracking changes and collaboration.
*   **Python Environment:** A virtual environment (e.g., using `venv`) to manage project dependencies.
*   **Terminal:** A standard command-line terminal for running scripts and managing the project.
